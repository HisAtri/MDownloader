# MDownloader

多镜像请求：适用于连接质量参差，或者QOS不稳定，有多个镜像服务器提供分发下载的情况下使用的下载工具

## 简介

### 问题分析

在一个多镜像请求的环境中，按照传统方式选择单一最优镜像站连接会遇到一些问题：
- 延迟检测/速率检测：小包的延迟数据不能代表大包的延迟；测试时的QoS不能代表下载全程的QoS
- 简单并行下载：多个节点下载速度不平衡会导致短板效应
- 动态响应/负载均衡：要求系统实时监控各个镜像的连接情况，逻辑较为复杂

### 解决方案

MDownloader提供了一种基于多线程和分片下载原理的多镜像下载工具，能够自然地在所有镜像中应用最优连接进行下载。

特点：
- 无需前期测试连接质量
- 多线程分片下载
- 对镜像站的可靠性要求为“长板效应”，可以容许大量失效、低速、无法连接的镜像站
- _正在准备_ 支持哈希表

缺点：
- 存在重复请求、存在更高的流量消耗与请求数消耗
- 可能刷爆S3和OFB的API（毕竟多线程下载）

### 应用场景

- 使用国外服务器提供下载
- 各地QoS参差不齐
- [MAA](https://github.com/MaaAssistantArknights/MaaAssistantArknights)

### 实现逻辑

```
// 开始下载
获取镜像站url列表[url1,url2,url3]
获取文件总大小：response.headers.get('Content-Length')
按照既定的分片大小进行文件分片，得到num_chunks个分片
确定分片请求的字节区间"Range: bytes=start-end"
创建分片状态表status=[0]*num_chunks

为每个url创建线程并加入线程池

每个线程的任务：
-检查状态表，选择下载的分片:
/*状态表三种状态，0:未下载，优先度最高;1:有线程在下载，优先度低;2:已经下载完成，无需下载。*/
    遍历状态表：
        如果当前区块为0:进行下载
        如果当前区块为1或2:继续寻找
    如果状态表中没有0:
        如果当前区块为1，下载
    如果状态表没有0和1：
        报告下载完成

多个线程同时下载一个区块时，下载最快的线程标记当前区块为下载完，并提示其它线程关闭连接。

下载完成后将临时文件夹中的所有分片合并，得到目标文件。

```
